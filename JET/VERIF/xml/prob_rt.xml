<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE workflow [

   <!ENTITY SCRIPT_DIR "/home/amb-verif/VERIF/bin">
   <!ENTITY EXEC_DIR   "/home/amb-verif/VERIF/exec">
   <!ENTITY STATIC_DIR "/home/amb-verif/VERIF/static">
   <!ENTITY WF_LOG_DIR "/home/amb-verif/VERIF/verif/prob/log">   

   <!ENTITY MAIN_DIR   "/home/amb-verif/VERIF/verif/prob">   
   <!ENTITY WEB_DIR    "/home/amb-verif/VERIF/verif/web">

   <!ENTITY NSSL_FILE "/home/amb-verif/VERIF/static/nssl_grid.nc">   
   <!ENTITY NSSL_MASK "/home/amb-verif/VERIF/static/nssl_hgt_mask.nc">   
   
   <!ENTITY OBS_REALTIME_DIR "/home/amb-verif/VERIF/verif/cref/NSSL/realtime">
   
   <!ENTITY CCFP_REALTIME_DIR "/home/amb-verif/VERIF/verif/prob/CCFP/realtime">
   <!ENTITY CCFP_LOG_DIR      "/home/amb-verif/VERIF/verif/prob/CCFP/log">
   <!ENTITY CCFP_DIR          "/public/data/rtvs/ccfp/final">
   
   <!ENTITY CCFP_verif_REALTIME_DIR "/home/amb-verif/VERIF/verif/prob/CCFPvNSSL/realtime">
   <!ENTITY CCFP_verif_LOG_DIR      "/home/amb-verif/VERIF/verif/prob/CCFPvNSSL/log">

   <!ENTITY HCPF_REALTIME_DIR "/home/amb-verif/VERIF/verif/prob/HCPF/realtime">
   <!ENTITY HCPF_LOG_DIR      "/home/amb-verif/VERIF/verif/prob/HCPF/log">
   <!ENTITY HCPF_DIR          "/home/rtrr/ensemble">
   
   <!ENTITY HCPF_verif_REALTIME_DIR "/home/amb-verif/VERIF/verif/prob/HCPFvNSSL/realtime">
   <!ENTITY HCPF_verif_LOG_DIR      "/home/amb-verif/VERIF/verif/prob/HCPFvNSSL/log">
   
   <!ENTITY RCPF_REALTIME_DIR "/home/amb-verif/VERIF/verif/prob/RCPF/realtime">
   <!ENTITY RCPF_LOG_DIR      "/home/amb-verif/VERIF/verif/prob/RCPF/log">
   <!ENTITY RCPF_DIR          "/public/data/gsd/13kmruc/rcpf">
   
   <!ENTITY RCPF_verif_REALTIME_DIR "/home/amb-verif/VERIF/verif/prob/RCPFvNSSL/realtime">
   <!ENTITY RCPF_verif_LOG_DIR      "/home/amb-verif/VERIF/verif/prob/RCPFvNSSL/log">

   <!ENTITY LLProb_REALTIME_DIR "/home/amb-verif/VERIF/verif/prob/LLProb/realtime">
   <!ENTITY LLProb_LOG_DIR      "/home/amb-verif/VERIF/verif/prob/LLProb/log">
   <!ENTITY LLProb_DIR          "/public/data/grids/mitll/probfcst/30">
   
   <!ENTITY LLProb_verif_REALTIME_DIR "/home/amb-verif/VERIF/verif/prob/LLProbvNSSL/realtime">
   <!ENTITY LLProb_verif_LOG_DIR      "/home/amb-verif/VERIF/verif/prob/LLProbvNSSL/log">

   <!ENTITY PROJECT "amb-verif">
   <!ENTITY PE "tjet:ujet:sjet:vjet:xjet">
   <!ENTITY PE_SERVICE "service">
   <!ENTITY PE_WALL_LIMIT "00:59:00">
   <!ENTITY SERVICE_WALL_LIMIT "00:59:00">
   <!ENTITY DEADLINE "12600">
   <!ENTITY STARTTIME "900">
   <!ENTITY STARTTIME2 "2400">

   <!ENTITY PE_OPTS 
       '<account>&PROJECT;</account>
        <partition>&PE;</partition>
        <cores>1</cores>
	<memory>2G</memory>
	<walltime>&PE_WALL_LIMIT;</walltime>
	<deadline><cyclestr offset="&DEADLINE;">@Y@m@d@H@M</cyclestr></deadline>'>

   <!ENTITY PE_LLProb_OPTS 
       '<account>&PROJECT;</account>
        <partition>&PE;</partition>
        <cores>1</cores>
	<memory>8G</memory>
	<walltime>&PE_WALL_LIMIT;</walltime>
	<deadline><cyclestr offset="&DEADLINE;">@Y@m@d@H@M</cyclestr></deadline>'>

   <!ENTITY SERVICE_OPTS 
       '<account>&PROJECT;</account>
        <partition>&PE_SERVICE;</partition>
        <cores>1</cores>
	<memory>2G</memory>
	<walltime>&SERVICE_WALL_LIMIT;</walltime>
	<deadline><cyclestr offset="&DEADLINE;">@Y@m@d@H@M</cyclestr></deadline>'>
	
   <!ENTITY YMDH
       '<envar>
	  <name>YEAR</name>
	  <value><cyclestr>@Y</cyclestr></value>
	</envar>
	<envar>
	  <name>MONTH</name>
	  <value><cyclestr>@m</cyclestr></value>
	</envar>
	<envar>
	  <name>DAY</name>
	  <value><cyclestr>@d</cyclestr></value>
	</envar>
	<envar>
	  <name>HOUR</name>
	  <value><cyclestr>@H</cyclestr></value>
	</envar>'>
   <!ENTITY YMDH7200
       '<envar>
	  <name>YEAR</name>
	  <value><cyclestr offset="-7200">@Y</cyclestr></value>
	</envar>
	<envar>
	  <name>MONTH</name>
	  <value><cyclestr offset="-7200">@m</cyclestr></value>
	</envar>
	<envar>
	  <name>DAY</name>
	  <value><cyclestr offset="-7200">@d</cyclestr></value>
	</envar>
	<envar>
	  <name>HOUR</name>
	  <value><cyclestr offset="-7200">@H</cyclestr></value>
	</envar>'>
   <!ENTITY YMDH10800
       '<envar>
	  <name>YEAR</name>
	  <value><cyclestr offset="-10800">@Y</cyclestr></value>
	</envar>
	<envar>
	  <name>MONTH</name>
	  <value><cyclestr offset="-10800">@m</cyclestr></value>
	</envar>
	<envar>
	  <name>DAY</name>
	  <value><cyclestr offset="-10800">@d</cyclestr></value>
	</envar>
	<envar>
	  <name>HOUR</name>
	  <value><cyclestr offset="-10800">@H</cyclestr></value>
	</envar>'>
]>

<workflow realtime="T" scheduler="slurm" cyclethrottle="2" cyclelifespan="0:02:00:00">

  <log><cyclestr>&WF_LOG_DIR;/workflow_@Y@m@d@H.log</cyclestr></log>

  <cycledef group="1hr">0 * * * 2023-2029 *</cycledef>
  <cycledef group="oddhr">0 1,3,5,7,9,11,13,15,17,19,21,22,23 * * 2013-2022 *</cycledef>

  <task name="CCFP_interp" cycledefs="oddhr" maxtries="2">
    <command>&SCRIPT_DIR;/wrapper.ksh</command>
    <jobname>CCFP_interp</jobname>
    <join><cyclestr>&CCFP_LOG_DIR;/CCFP_interp@Y@m@d@H.log</cyclestr></join>
    
    &PE_OPTS;    
    &YMDH;

    <envar>
      <name>SCRIPT</name>
      <value>&SCRIPT_DIR;/CCFP_interp.py</value>
    </envar>
    <envar>
      <name>STATICDIR</name>
      <value>&STATIC_DIR;</value>
    </envar>
    <envar>
      <name>EXECDIR</name>
      <value>&EXEC_DIR;</value>
    </envar>
    <envar>
      <name>SCRIPTDIR</name>
      <value>&SCRIPT_DIR;</value>
    </envar>
    <envar>
      <name>REALTIMEDIR</name>
      <value>&CCFP_REALTIME_DIR;</value>
    </envar>
    <envar>
      <name>SRCDIR</name>
      <value>&CCFP_DIR;</value>
    </envar>
   
    <envar>
      <name>IPOPTS</name>
      <value>2 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1</value>
    </envar>

    <dependency>
      <and>
        <timedep><cyclestr offset="&STARTTIME;">@Y@m@d@H@M@S</cyclestr></timedep>
	<datadep age="120"><cyclestr>&CCFP_DIR;/@Y@m@d_@HZ.idl</cyclestr></datadep>
      </and>
    </dependency>

  </task>

  <metatask>
     <var name="grid">03km</var>
   
     <task name="CCFP_verif_#grid#" cycledefs="oddhr" maxtries="2">
        <command>&SCRIPT_DIR;/wrapper.ksh</command>
	<jobname>CCFP_#grid#</jobname>
	<join><cyclestr>&CCFP_verif_LOG_DIR;/CCFP_verif_#grid#_@Y@m@d@H.log</cyclestr></join>

	&PE_OPTS;    
	&YMDH7200;
	
	<envar>
          <name>SCRIPT</name>
          <value>&SCRIPT_DIR;/Prob_NSSL_verif.py</value>
        </envar>
	<envar>
	  <name>EXECDIR</name>
	  <value>&EXEC_DIR;</value>
        </envar>
        <envar>
          <name>REALTIMEDIR</name>
          <value>&CCFP_verif_REALTIME_DIR;</value>
        </envar>
        <envar>
	  <name>SCRIPTDIR</name>
	  <value>&SCRIPT_DIR;</value>
	</envar>
	<envar>
	  <name>OBSDIR</name>
	  <value>&OBS_REALTIME_DIR;</value>
	</envar>
	<envar>
	  <name>MODELDIR</name>
	  <value>&CCFP_REALTIME_DIR;</value>
	</envar>
    
        <envar>
          <name>STATFILE</name>
          <value>verif_#grid#</value>
        </envar>
        <envar>
	  <name>OBSFILE</name>
	  <value>nssl</value>
        </envar>
	
	<envar>
	  <name>INTERPGRID</name>
	  <value>#grid#LC</value>
	</envar>
	<envar>
	  <name>GRID</name>
	  <value>#grid#</value>
        </envar>
	
	<envar>
	 <name>NCOUTVAR</name>
	  <value>cov_conf</value>
        </envar>  
	<envar>
	  <name>MODEL</name>
	  <value>ccfp</value>
	</envar>
	<envar>
	  <name>NCLMODEL</name>
	  <value>CCFP</value>
	</envar>

	<envar>
	  <name>THRESHOLDS</name>
	  <value>0.25 0.40 0.75</value>
        </envar>
        <envar>
	  <name>FORECASTLEADS</name>
	  <value>4 6 8</value>
        </envar>

	<dependency>
	    <taskdep task="CCFP_interp"/>
        </dependency>
   
      </task>
   </metatask>

   <task name="RCPF_interp" cycledefs="1hr" maxtries="2">
    <command>&SCRIPT_DIR;/wrapper.ksh</command>
    <jobname>RCPF_interp</jobname>
    <join><cyclestr offset="-7200">&RCPF_LOG_DIR;/RCPF_interp@Y@m@d@H.log</cyclestr></join>
    
    &PE_OPTS;    
    &YMDH7200;

    <envar>
      <name>SCRIPT</name>
      <value>&SCRIPT_DIR;/RCPF_interp.py</value>
    </envar>
    <envar>
      <name>EXECDIR</name>
      <value>&EXEC_DIR;</value>
    </envar>
    <envar>
      <name>SCRIPTDIR</name>
      <value>&SCRIPT_DIR;</value>
    </envar>
    <envar>
      <name>REALTIMEDIR</name>
      <value>&RCPF_REALTIME_DIR;</value>
    </envar>
    <envar>
      <name>MODELDIR</name>
      <value>&RCPF_DIR;</value>
    </envar>
   
    <envar>
      <name>FORECASTLEADS</name>
      <value>0 1 2 3 4 5 6 7 8 9 10</value>
    </envar>

  </task>
 
  <metatask>
     <var name="grid">03km</var>
   
     <task name="RCPF_verif_#grid#" cycledefs="1hr" maxtries="2">
        <command>&SCRIPT_DIR;/wrapper.ksh</command>
	<jobname>RCPF_#grid#</jobname>
	<join><cyclestr offset="-7200">&RCPF_verif_LOG_DIR;/RCPF_verif_#grid#_@Y@m@d@H.log</cyclestr></join>

	&PE_OPTS;    
	&YMDH7200;
	
	<envar>
          <name>SCRIPT</name>
          <value>&SCRIPT_DIR;/Prob_NSSL_verif.py</value>
        </envar>
	<envar>
	  <name>EXECDIR</name>
	  <value>&EXEC_DIR;</value>
        </envar>
        <envar>
          <name>REALTIMEDIR</name>
          <value>&RCPF_verif_REALTIME_DIR;</value>
        </envar>
        <envar>
	  <name>SCRIPTDIR</name>
	  <value>&SCRIPT_DIR;</value>
	</envar>
	<envar>
	  <name>OBSDIR</name>
	  <value>&OBS_REALTIME_DIR;</value>
	</envar>
	<envar>
	  <name>MODELDIR</name>
	  <value>&RCPF_REALTIME_DIR;</value>
	</envar>
    
        <envar>
          <name>STATFILE</name>
          <value>verif_#grid#</value>
        </envar>
        <envar>
	  <name>OBSFILE</name>
	  <value>nssl</value>
        </envar>
	
	<envar>
	  <name>INTERPGRID</name>
	  <value>#grid#LC</value>
	</envar>
	<envar>
	  <name>GRID</name>
	  <value>#grid#</value>
        </envar>
	
	<envar>
	 <name>NCOUTVAR</name>
	  <value>prob</value>
        </envar>  
	<envar>
	  <name>MODEL</name>
	  <value>rcpf</value>
	</envar>
	<envar>
	  <name>NCLMODEL</name>
	  <value>RCPF</value>
	</envar>

	<envar>
	  <name>THRESHOLDS</name>
	  <value>0.10 0.20 0.25 0.30 0.40 0.50 0.60 0.70 0.75 0.80 0.90</value>
        </envar>
        <envar>
	  <name>FORECASTLEADS</name>
	  <value>0 1 2 3 4 5 6 7 8 9 10</value>
        </envar>

	<dependency>
          <and>
	    <datadep age="120"><cyclestr offset="-7200">&OBS_REALTIME_DIR;/@Y@m@d-@Hz/nssl_mosaic_03kmLC.nc</cyclestr></datadep>
	    <taskdep task="RCPF_interp"/>
          </and>
        </dependency>
    
      </task>
    </metatask>

    <task name="HCPF_interp" cycledefs="1hr" maxtries="2">
    <command>&SCRIPT_DIR;/wrapper.ksh</command>
    <jobname>HCPF_interp</jobname>
    <join><cyclestr offset="-7200">&HCPF_LOG_DIR;/HCPF_interp@Y@m@d@H.log</cyclestr></join>
    
    &PE_OPTS;    
    &YMDH7200;

    <envar>
      <name>SCRIPT</name>
      <value>&SCRIPT_DIR;/HCPF_interp.py</value>
    </envar>
    <envar>
      <name>EXECDIR</name>
      <value>&EXEC_DIR;</value>
    </envar>
    <envar>
      <name>SCRIPTDIR</name>
      <value>&SCRIPT_DIR;</value>
    </envar>
    <envar>
      <name>REALTIMEDIR</name>
      <value>&HCPF_REALTIME_DIR;</value>
    </envar>
    <envar>
      <name>MODELDIR</name>
      <value>&HCPF_DIR;</value>
    </envar>
   
    <envar>
      <name>FCSTLEADS</name>
      <value>0 1 2 3 4 5 6 7 8 9 10</value>
    </envar>

    <dependency>
      <timedep><cyclestr offset="&STARTTIME2;">@Y@m@d@H@M@S</cyclestr></timedep>
    </dependency>

  </task>
 
  <metatask>
     <var name="grid">03km</var>
   
     <task name="HCPF_verif_#grid#" cycledefs="1hr" maxtries="2">
        <command>&SCRIPT_DIR;/wrapper.ksh</command>
	<jobname>HCPF_#grid#</jobname>
	<join><cyclestr offset="-7200">&HCPF_verif_LOG_DIR;/HCPF_verif_#grid#_@Y@m@d@H.log</cyclestr></join>

	&PE_OPTS;    
	&YMDH7200;
	
	<envar>
          <name>SCRIPT</name>
          <value>&SCRIPT_DIR;/Prob_NSSL_verif.py</value>
        </envar>
	<envar>
	  <name>EXECDIR</name>
	  <value>&EXEC_DIR;</value>
        </envar>
        <envar>
          <name>REALTIMEDIR</name>
          <value>&HCPF_verif_REALTIME_DIR;</value>
        </envar>
        <envar>
	  <name>SCRIPTDIR</name>
	  <value>&SCRIPT_DIR;</value>
	</envar>
	<envar>
	  <name>OBSDIR</name>
	  <value>&OBS_REALTIME_DIR;</value>
	</envar>
	<envar>
	  <name>MODELDIR</name>
	  <value>&HCPF_REALTIME_DIR;</value>
	</envar>
    
        <envar>
          <name>STATFILE</name>
          <value>verif_#grid#</value>
        </envar>
        <envar>
	  <name>OBSFILE</name>
	  <value>nssl</value>
        </envar>
	
	<envar>
	  <name>INTERPGRID</name>
	  <value>#grid#LC</value>
	</envar>
	<envar>
	  <name>GRID</name>
	  <value>#grid#</value>
        </envar>
	
	<envar>
	 <name>NCOUTVAR</name>
	  <value>prob</value>
        </envar>  
	<envar>
	  <name>MODEL</name>
	  <value>hcpf</value>
	</envar>
	<envar>
	  <name>NCLMODEL</name>
	  <value>HCPF</value>
	</envar>

	<envar>
	  <name>THRESHOLDS</name>
	  <value>0.10 0.20 0.25 0.30 0.40 0.50 0.60 0.70 0.75 0.80 0.90</value>
        </envar>
        <envar>
	  <name>FORECASTLEADS</name>
	  <value>0 1 2 3 4 5 6 7 8 9 10</value>
        </envar>

	<dependency>
          <and>
	    <datadep age="120"><cyclestr offset="-7200">&OBS_REALTIME_DIR;/@Y@m@d-@Hz/nssl_mosaic_03kmLC.nc</cyclestr></datadep>
	    <taskdep task="HCPF_interp"/>
          </and>
        </dependency>
    
      </task>
    </metatask>
<!--
    <task name="LLProb_interp" cycledefs="1hr" maxtries="2">
    <command>&SCRIPT_DIR;/wrapper.ksh</command>
    <jobname>LLProb_interp</jobname>
    <join><cyclestr>&LLProb_LOG_DIR;/LLProb_interp@Y@m@d@H.log</cyclestr></join>
    
    &PE_LLProb_OPTS;    
    &YMDH;

    <envar>
      <name>SCRIPT</name>
      <value>&SCRIPT_DIR;/LLProb_interp.py</value>
    </envar>
    <envar>
      <name>EXECDIR</name>
      <value>&EXEC_DIR;</value>
    </envar>
    <envar>
      <name>SCRIPTDIR</name>
      <value>&SCRIPT_DIR;</value>
    </envar>
    <envar>
      <name>REALTIMEDIR</name>
      <value>&LLProb_REALTIME_DIR;</value>
    </envar>
    <envar>
      <name>SRCDIR</name>
      <value>&LLProb_DIR;</value>
    </envar>
   
    <dependency>
      <timedep><cyclestr offset="&STARTTIME;">@Y@m@d@H@M@S</cyclestr></timedep>
    </dependency>

  </task>

  <metatask>
     <var name="grid">04km 80km</var>
   
     <task name="LLProb_verif_#grid#" cycledefs="oddhr" maxtries="2">
        <command>&SCRIPT_DIR;/wrapper.ksh</command>
	<jobname>LLProb_#grid#</jobname>
	<join><cyclestr>&LLProb_verif_LOG_DIR;/LLProb_verif_#grid#_@Y@m@d@H.log</cyclestr></join>

	&PE_LLProb_OPTS;    
	&YMDH;
	
	<envar>
          <name>SCRIPT</name>
          <value>&SCRIPT_DIR;/Prob_NSSL_verif.py</value>
        </envar>
	<envar>
	  <name>EXECDIR</name>
	  <value>&EXEC_DIR;</value>
        </envar>
        <envar>
          <name>REALTIMEDIR</name>
          <value>&LLProb_verif_REALTIME_DIR;</value>
        </envar>
        <envar>
	  <name>SCRIPTDIR</name>
	  <value>&SCRIPT_DIR;</value>
	</envar>
	<envar>
	  <name>OBSDIR</name>
	  <value>&OBS_REALTIME_DIR;</value>
	</envar>
	<envar>
	  <name>MODELDIR</name>
	  <value>&LLProb_REALTIME_DIR;</value>
	</envar>
    
        <envar>
          <name>STATFILE</name>
          <value>verif_#grid#</value>
        </envar>
        <envar>
	  <name>OBSFILE</name>
	  <value>ncwd</value>
        </envar>
	
	<envar>
	  <name>INTERPGRID</name>
	  <value>ncwd_#grid#</value>
	</envar>
	<envar>
	  <name>GRID</name>
	  <value>#grid#</value>
        </envar>
	
	<envar>
	 <name>NCOUTVAR</name>
	  <value>prob</value>
        </envar>  
	<envar>
	  <name>MODEL</name>
	  <value>llprob</value>
	</envar>
	<envar>
	  <name>NCLMODEL</name>
	  <value>LLProb</value>
	</envar>

	<envar>
	  <name>THRESHOLDS</name>
	  <value>0.10 0.20 0.25 0.30 0.40 0.50 0.60 0.70 0.75 0.80 0.90</value>
        </envar>
        <envar>
	  <name>FORECASTLEADS</name>
	  <value>1 2 3 4 5 6 7</value>
        </envar>

	<dependency>
          <and>
	    <taskdep task="NSSL_interp"/>
	    <taskdep task="LLProb_interp"/>
          </and>
        </dependency>
    
      </task>
    </metatask>
-->
    <task name="prob_db" cycledefs="1hr" maxtries="2">    
      <command>&SCRIPT_DIR;/pop_prob_sql_tables.py</command>
      <jobname>prob_db</jobname>
      <join><cyclestr offset="-10800">&WF_LOG_DIR;/prob_db_@Y@m@d@H.log</cyclestr></join>
        
      &SERVICE_OPTS;
      &YMDH10800;
        
      <envar>
        <name>REALTIMEDIR</name>
        <value>&MAIN_DIR;</value>
      </envar>

    </task>

</workflow>
