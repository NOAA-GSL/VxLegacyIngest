<?xml version="1.0" encoding="UTF-8"?>

<!DOCTYPE workflow [

<!-- switches -->
<!ENTITY PRECIP_SWITCH "NO">
<!ENTITY RUN_THIS_TASK "</false>">
<!-- change this if you ever change the number of forecast hours to process -->
<!ENTITY NFHRS "18">

<!ENTITY SCRIPT_DIR "/home/amb-verif/MODE_realtime_verif/bin">
<!ENTITY WF_LOG_DIR "/home/amb-verif/MODE_realtime_verif/verif/mode_rt/log">
<!ENTITY MAIN_DIR "/home/amb-verif/MODE_realtime_verif/verif/mode_rt">
<!ENTITY WEB_DIR "/home/amb-verif/MODE_realtime_verif/verif/web">
<!ENTITY CONFIG_DIR "/home/amb-verif/MODE_realtime_verif/config">
<!ENTITY STATIC_DIR "/home/amb-verif/MODE_realtime_verif/static">
<!ENTITY MET_DIR "/contrib/met/10.0.0/">
<!ENTITY MET_BASE "/contrib/met/10.0.0/share/met/">
<!ENTITY PYTHON_PATH "/lfs1/BMC/amb-verif/anaconda3/bin/python3">
<!ENTITY MVLOAD_PATH "/home/amb-verif/tcmet/bin/met_db_load.py">

<!ENTITY HRRR_OPS_REALTIME_DIR "/home/amb-verif/MODE_realtime_verif/verif/mode_rt/HRRR_OPS/realtime">
<!ENTITY HRRR_OPS_LOG_DIR "/home/amb-verif/MODE_realtime_verif/verif/mode_rt/HRRR_OPS/log">
    
<!ENTITY RRFS_NA_3km_dev1_HRRR_REALTIME_DIR "/home/amb-verif/MODE_realtime_verif/verif/mode_rt/RRFS_NA_3km_dev1_HRRR/realtime">
<!ENTITY RRFS_NA_3km_dev1_HRRR_LOG_DIR "/home/amb-verif/MODE_realtime_verif/verif/mode_rt/RRFS_NA_3km_dev1_HRRR/log">
    
<!ENTITY RRFS_A_REALTIME_DIR "/home/amb-verif/MODE_realtime_verif/verif/mode_rt/RRFS_A/realtime">
<!ENTITY RRFS_A_LOG_DIR "/home/amb-verif/MODE_realtime_verif/verif/mode_rt/RRFS_A/log">
    
<!ENTITY RRFS_B_REALTIME_DIR "/home/amb-verif/MODE_realtime_verif/verif/mode_rt/RRFS_B/realtime">
<!ENTITY RRFS_B_LOG_DIR "/home/amb-verif/MODE_realtime_verif/verif/mode_rt/RRFS_B/log">
    
<!ENTITY OBS_REALTIME_DIR "/home/amb-verif/MODE_realtime_verif/verif/mode_rt/OBS/realtime">
<!ENTITY OBS_LOG_DIR "/home/amb-verif/MODE_realtime_verif/verif/mode_rt/OBS/log">
    
<!ENTITY PROJECT "amb-verif">
<!ENTITY PE "tjet:ujet:sjet:vjet:xjet">
<!--
<!ENTITY PE_SERVICE "service">
<!ENTITY PE "ppa">
-->
<!ENTITY PE_SERVICE "ppa-service">
<!ENTITY PE_WALL_LIMIT "04:00:00">
<!ENTITY SERVICE_WALL_LIMIT "04:00:00">
<!ENTITY DEADLINE "21:00:00">
<!ENTITY WAIT "1200">

<!ENTITY PE_OPTS
   '<account>&PROJECT;</account>
    <partition>&PE;</partition>
    <native>--exclusive</native>
    <cores>1</cores>
    <memory>10G</memory>
    <walltime>&PE_WALL_LIMIT;</walltime>
    <deadline><cyclestr offset="&DEADLINE;">@Y@m@d@H@M</cyclestr></deadline>'>

<!ENTITY LITE_OPTS
   '<account>&PROJECT;</account>
    <partition>&PE;</partition>
    <cores>1</cores>
    <memory>2G</memory>
    <walltime>&SERVICE_WALL_LIMIT;</walltime>
    <deadline><cyclestr offset="&WAIT;">@Y@m@d@H@M</cyclestr></deadline>'>

<!ENTITY SERVICE_OPTS
   '<account>&PROJECT;</account>
    <partition>&PE_SERVICE;</partition>
    <native>--exclusive</native>
    <cores>1</cores>
    <memory>10G</memory>
    <walltime>&SERVICE_WALL_LIMIT;</walltime>
    <deadline><cyclestr offset="&DEADLINE;">@Y@m@d@H@M</cyclestr></deadline>'>
        
<!ENTITY YMDH86400
   '<envar>
      <name>YEAR</name>
      <value><cyclestr offset="-86400">@Y</cyclestr></value>
    </envar>
    <envar>
      <name>MONTH</name>
      <value><cyclestr offset="-86400">@m</cyclestr></value>
    </envar>
    <envar>
      <name>DAY</name>
      <value><cyclestr offset="-86400">@d</cyclestr></value>
    </envar>
    <envar>
      <name>HOUR</name>
      <value><cyclestr offset="-86400">@H</cyclestr></value>
    </envar>
    <envar>
      <name>YYYYMMDDHH</name>
      <value><cyclestr offset="-86400">@Y@m@d@H</cyclestr></value>
    </envar>'>

<!ENTITY YMDH104400
   '<envar>
      <name>YEAR</name>
      <value><cyclestr offset="-104400">@Y</cyclestr></value>
    </envar>
    <envar>
      <name>MONTH</name>
      <value><cyclestr offset="-104400">@m</cyclestr></value>
    </envar>
    <envar>
      <name>DAY</name>
      <value><cyclestr offset="-104400">@d</cyclestr></value>
    </envar>
    <envar>
      <name>HOUR</name>
      <value><cyclestr offset="-104400">@H</cyclestr></value>
    </envar>
    <envar>
      <name>YYYYMMDDHH</name>
      <value><cyclestr offset="-104400">@Y@m@d@H</cyclestr></value>
    </envar>'>

<!ENTITY YMDH108000
   '<envar>
      <name>YEAR</name>
      <value><cyclestr offset="-108000">@Y</cyclestr></value>
    </envar>
    <envar>
      <name>MONTH</name>
      <value><cyclestr offset="-108000">@m</cyclestr></value>
    </envar>
    <envar>
      <name>DAY</name>
      <value><cyclestr offset="-108000">@d</cyclestr></value>
    </envar>
    <envar>
      <name>HOUR</name>
      <value><cyclestr offset="-108000">@H</cyclestr></value>
    </envar>
    <envar>
      <name>YYYYMMDDHH</name>
      <value><cyclestr offset="-108000">@Y@m@d@H</cyclestr></value>
    </envar>'>

]>

<workflow realtime="T" scheduler="slurm" cyclethrottle="36" cyclelifespan="21:00:00">

  <cycledef group="all">00 * * * 2020-2029 *</cycledef>
  <cycledef group="6hr">0 0,6,12,18 * * 2020-2029 *</cycledef>

  <log><cyclestr>&WF_LOG_DIR;/workflow_met_@Y@m@d@H.log</cyclestr></log>

  <metatask>

     <var name="fhr">00 01 02 03 04 05 06 07 08 09 10 11 12 13 14 15 16 17 18</var>

     <task name="HRRR_OPS_MODE_compref_#fhr#" cycledefs="all" maxtries="2">
        <command>&SCRIPT_DIR;/run_mode_rt.ksh</command>
        <jobname><cyclestr offset="-86400">HRRR_OPS_MODE_compref_@Y@m@d@H_f#fhr#</cyclestr></jobname>
        <join><cyclestr offset="-86400">&HRRR_OPS_LOG_DIR;/compref/HRRR_OPS_mode_@Y@m@d@H_f#fhr#.out</cyclestr></join>

        &PE_OPTS;
        &YMDH86400;

        <envar>
          <name>FCST_FILE_DIR</name>
          <value>&HRRR_OPS_REALTIME_DIR;</value>
        </envar>
        <envar>
          <name>OBS_FILE_DIR</name>
          <value>&OBS_REALTIME_DIR;</value>
        </envar>
        <envar>
          <name>OUT_DIR</name>
          <value>&MAIN_DIR;/HRRR_OPS/compref/<cyclestr offset="-86400">@Y@m@d-@H</cyclestr></value>
        </envar>
        <envar>
          <name>FHR</name>
          <value>#fhr#</value>
        </envar>
        <envar>
          <name>FIELD</name>
          <value>compref</value>
        </envar>
        <envar>
          <name>CONFIG_DIR</name>
          <value>&CONFIG_DIR;</value>
        </envar>
        <envar>
          <name>STATIC_DIR</name>
          <value>&STATIC_DIR;</value>
        </envar>
        <envar>
          <name>MODEL_NAME</name>
          <value>HRRR_OPS</value>
        </envar>
        <envar>
          <name>MET_BASE</name>
          <value>&MET_BASE;</value>
        </envar>

        <dependency>
          <datadep>&OBS_REALTIME_DIR;/compref/<cyclestr offset="-86400">MRMS_compref_@Y@m@d_@H@M.grib2</cyclestr></datadep>
        </dependency>

     </task>

     <task name="RRFS_NA_3km_dev1_HRRR_MODE_compref_#fhr#" cycledefs="all" maxtries="2">
        <command>&SCRIPT_DIR;/run_mode_rt.ksh</command>
        <jobname><cyclestr offset="-86400">RRFS_NA_3km_dev1_HRRR_MODE_compref_@Y@m@d@H_f#fhr#</cyclestr></jobname>
        <join><cyclestr offset="-86400">&RRFS_NA_3km_dev1_HRRR_LOG_DIR;/compref/RRFS_NA_3km_dev1_HRRR_mode_@Y@m@d@H_f#fhr#.out</cyclestr></join>

        &PE_OPTS;
        &YMDH86400;

        <envar>
          <name>FCST_FILE_DIR</name>
          <value>&RRFS_NA_3km_dev1_HRRR_REALTIME_DIR;</value>
        </envar>
        <envar>
          <name>OBS_FILE_DIR</name>
          <value>&OBS_REALTIME_DIR;</value>
        </envar>
        <envar>
          <name>OUT_DIR</name>
          <value>&MAIN_DIR;/RRFS_NA_3km_dev1_HRRR/compref/<cyclestr offset="-86400">@Y@m@d-@H</cyclestr></value>
        </envar>
        <envar>
          <name>FHR</name>
          <value>#fhr#</value>
        </envar>
        <envar>
          <name>FIELD</name>
          <value>compref</value>
        </envar>
        <envar>
          <name>CONFIG_DIR</name>
          <value>&CONFIG_DIR;</value>
        </envar>
        <envar>
          <name>STATIC_DIR</name>
          <value>&STATIC_DIR;</value>
        </envar>
        <envar>
          <name>MODEL_NAME</name>
          <value>RRFS_NA_3km_dev1_HRRR</value>
        </envar>
        <envar>
          <name>MET_BASE</name>
          <value>&MET_BASE;</value>
        </envar>

        <dependency>
          <datadep>&OBS_REALTIME_DIR;/compref/<cyclestr offset="-86400">MRMS_compref_@Y@m@d_@H@M.grib2</cyclestr></datadep>
        </dependency>

     </task>

     <task name="RRFS_A_MODE_compref_#fhr#" cycledefs="all" maxtries="2">
        <command>&SCRIPT_DIR;/run_mode_rt.ksh</command>
        <jobname><cyclestr offset="-86400">RRFS_A_MODE_compref_@Y@m@d@H_f#fhr#</cyclestr></jobname>
        <join><cyclestr offset="-86400">&RRFS_A_LOG_DIR;/compref/RRFS_A_mode_@Y@m@d@H_f#fhr#.out</cyclestr></join>

        &PE_OPTS;
        &YMDH86400;

        <envar>
          <name>FCST_FILE_DIR</name>
          <value>&RRFS_A_REALTIME_DIR;</value>
        </envar>
        <envar>
          <name>OBS_FILE_DIR</name>
          <value>&OBS_REALTIME_DIR;</value>
        </envar>
        <envar>
          <name>OUT_DIR</name>
          <value>&MAIN_DIR;/RRFS_A/compref/<cyclestr offset="-86400">@Y@m@d-@H</cyclestr></value>
        </envar>
        <envar>
          <name>FHR</name>
          <value>#fhr#</value>
        </envar>
        <envar>
          <name>FIELD</name>
          <value>compref</value>
        </envar>
        <envar>
          <name>CONFIG_DIR</name>
          <value>&CONFIG_DIR;</value>
        </envar>
        <envar>
          <name>STATIC_DIR</name>
          <value>&STATIC_DIR;</value>
        </envar>
        <envar>
          <name>MODEL_NAME</name>
          <value>RRFS_A</value>
        </envar>
        <envar>
          <name>MET_BASE</name>
          <value>&MET_BASE;</value>
        </envar>

        <dependency>
          <datadep>&OBS_REALTIME_DIR;/compref/<cyclestr offset="-86400">MRMS_compref_@Y@m@d_@H@M.grib2</cyclestr></datadep>
        </dependency>

     </task>

     <task name="RRFS_B_MODE_compref_#fhr#" cycledefs="all" maxtries="2">
        <command>&SCRIPT_DIR;/run_mode_rt.ksh</command>
        <jobname><cyclestr offset="-86400">RRFS_B_MODE_compref_@Y@m@d@H_f#fhr#</cyclestr></jobname>
        <join><cyclestr offset="-86400">&RRFS_B_LOG_DIR;/compref/RRFS_B_mode_@Y@m@d@H_f#fhr#.out</cyclestr></join>

        &PE_OPTS;
        &YMDH86400;

        <envar>
          <name>FCST_FILE_DIR</name>
          <value>&RRFS_B_REALTIME_DIR;</value>
        </envar>
        <envar>
          <name>OBS_FILE_DIR</name>
          <value>&OBS_REALTIME_DIR;</value>
        </envar>
        <envar>
          <name>OUT_DIR</name>
          <value>&MAIN_DIR;/RRFS_B/compref/<cyclestr offset="-86400">@Y@m@d-@H</cyclestr></value>
        </envar>
        <envar>
          <name>FHR</name>
          <value>#fhr#</value>
        </envar>
        <envar>
          <name>FIELD</name>
          <value>compref</value>
        </envar>
        <envar>
          <name>CONFIG_DIR</name>
          <value>&CONFIG_DIR;</value>
        </envar>
        <envar>
          <name>STATIC_DIR</name>
          <value>&STATIC_DIR;</value>
        </envar>
        <envar>
          <name>MODEL_NAME</name>
          <value>RRFS_B</value>
        </envar>
        <envar>
          <name>MET_BASE</name>
          <value>&MET_BASE;</value>
        </envar>

        <dependency>
          <datadep>&OBS_REALTIME_DIR;/compref/<cyclestr offset="-86400">MRMS_compref_@Y@m@d_@H@M.grib2</cyclestr></datadep>
        </dependency>

     </task>

   </metatask>

   <metatask>

     <var name="fhr">06 12 18 24 30 36</var>

     <task name="HRRR_OPS_MODE_precipi_#fhr#" cycledefs="6hr" maxtries="2">

        <command>&SCRIPT_DIR;/run_mode_rt_with_pcp_combine.ksh</command>
        <jobname><cyclestr offset="-86400">HRRR_OPS_MODE_precip_@Y@m@d@H_f#fhr#</cyclestr></jobname>
        <join><cyclestr offset="-86400">&HRRR_OPS_LOG_DIR;/precip/HRRR_OPS_mode_@Y@m@d@H_f#fhr#.out</cyclestr></join>

        &PE_OPTS;
        &YMDH86400;

        <envar>
          <name>FCST_FILE_DIR</name>
          <value>&HRRR_OPS_REALTIME_DIR;</value>
        </envar>
        <envar>
          <name>OBS_FILE_DIR</name>
          <value>&OBS_REALTIME_DIR;</value>
        </envar>
        <envar>
          <name>OUT_DIR</name>
          <value>&MAIN_DIR;/HRRR_OPS/precip/<cyclestr offset="-86400">@Y@m@d-@H</cyclestr></value>
        </envar>
        <envar>
          <name>FHR</name>
          <value>#fhr#</value>
        </envar>
        <envar>
          <name>FIELD</name>
          <value>precip</value>
        </envar>
        <envar>
          <name>CONFIG_DIR</name>
          <value>&CONFIG_DIR;</value>
        </envar>
        <envar>
          <name>STATIC_DIR</name>
          <value>&STATIC_DIR;</value>
        </envar>
        <envar>
          <name>MODEL_NAME</name>
          <value>HRRR_OPS</value>
        </envar>
        <envar>
          <name>MET_BASE</name>
          <value>&MET_BASE;</value>
        </envar>

        <dependency>
          <datadep>&OBS_REALTIME_DIR;/precip/<cyclestr offset="-86400">st4_conus.@Y@m@d@H.06h.grib2</cyclestr></datadep>
        </dependency>

     </task>

     <task name="RRFS_NA_3km_dev1_HRRR_MODE_precipi_#fhr#" cycledefs="6hr" maxtries="2">

        <command>&SCRIPT_DIR;/run_mode_rt_with_pcp_combine.ksh</command>
        <jobname><cyclestr offset="-86400">RRFS_NA_3km_dev1_HRRR_MODE_precip_@Y@m@d@H_f#fhr#</cyclestr></jobname>
        <join><cyclestr offset="-86400">&RRFS_NA_3km_dev1_HRRR_LOG_DIR;/precip/RRFS_NA_3km_dev1_HRRR_mode_@Y@m@d@H_f#fhr#.out</cyclestr></join>

        &PE_OPTS;
        &YMDH86400;

        <envar>
          <name>FCST_FILE_DIR</name>
          <value>&RRFS_NA_3km_dev1_HRRR_REALTIME_DIR;</value>
        </envar>
        <envar>
          <name>OBS_FILE_DIR</name>
          <value>&OBS_REALTIME_DIR;</value>
        </envar>
        <envar>
          <name>OUT_DIR</name>
          <value>&MAIN_DIR;/RRFS_NA_3km_dev1_HRRR/precip/<cyclestr offset="-86400">@Y@m@d-@H</cyclestr></value>
        </envar>
        <envar>
          <name>FHR</name>
          <value>#fhr#</value>
        </envar>
        <envar>
          <name>FIELD</name>
          <value>precip</value>
        </envar>
        <envar>
          <name>CONFIG_DIR</name>
          <value>&CONFIG_DIR;</value>
        </envar>
        <envar>
          <name>STATIC_DIR</name>
          <value>&STATIC_DIR;</value>
        </envar>
        <envar>
          <name>MODEL_NAME</name>
          <value>RRFS_NA_3km_dev1_HRRR</value>
        </envar>
        <envar>
          <name>MET_BASE</name>
          <value>&MET_BASE;</value>
        </envar>

        <dependency>
          <datadep>&OBS_REALTIME_DIR;/precip/<cyclestr offset="-86400">st4_conus.@Y@m@d@H.06h.grib2</cyclestr></datadep>
        </dependency>

     </task>

     <task name="RRFS_A_MODE_precipi_#fhr#" cycledefs="6hr" maxtries="2">

        <command>&SCRIPT_DIR;/run_mode_rt_with_pcp_combine.ksh</command>
        <jobname><cyclestr offset="-86400">RRFS_A_MODE_precip_@Y@m@d@H_f#fhr#</cyclestr></jobname>
        <join><cyclestr offset="-86400">&RRFS_A_LOG_DIR;/precip/RRFS_A_mode_@Y@m@d@H_f#fhr#.out</cyclestr></join>

        &PE_OPTS;
        &YMDH86400;

        <envar>
          <name>FCST_FILE_DIR</name>
          <value>&RRFS_A_REALTIME_DIR;</value>
        </envar>
        <envar>
          <name>OBS_FILE_DIR</name>
          <value>&OBS_REALTIME_DIR;</value>
        </envar>
        <envar>
          <name>OUT_DIR</name>
          <value>&MAIN_DIR;/RRFS_A/precip/<cyclestr offset="-86400">@Y@m@d-@H</cyclestr></value>
        </envar>
        <envar>
          <name>FHR</name>
          <value>#fhr#</value>
        </envar>
        <envar>
          <name>FIELD</name>
          <value>precip</value>
        </envar>
        <envar>
          <name>CONFIG_DIR</name>
          <value>&CONFIG_DIR;</value>
        </envar>
        <envar>
          <name>STATIC_DIR</name>
          <value>&STATIC_DIR;</value>
        </envar>
        <envar>
          <name>MODEL_NAME</name>
          <value>RRFS_A</value>
        </envar>
        <envar>
          <name>MET_BASE</name>
          <value>&MET_BASE;</value>
        </envar>

        <dependency>
          <datadep>&OBS_REALTIME_DIR;/precip/<cyclestr offset="-86400">st4_conus.@Y@m@d@H.06h.grib2</cyclestr></datadep>
        </dependency>

     </task>

     <task name="RRFS_B_MODE_precipi_#fhr#" cycledefs="6hr" maxtries="2">

        <command>&SCRIPT_DIR;/run_mode_rt_with_pcp_combine.ksh</command>
        <jobname><cyclestr offset="-86400">RRFS_B_MODE_precip_@Y@m@d@H_f#fhr#</cyclestr></jobname>
        <join><cyclestr offset="-86400">&RRFS_B_LOG_DIR;/precip/RRFS_B_mode_@Y@m@d@H_f#fhr#.out</cyclestr></join>

        &PE_OPTS;
        &YMDH86400;

        <envar>
          <name>FCST_FILE_DIR</name>
          <value>&RRFS_B_REALTIME_DIR;</value>
        </envar>
        <envar>
          <name>OBS_FILE_DIR</name>
          <value>&OBS_REALTIME_DIR;</value>
        </envar>
        <envar>
          <name>OUT_DIR</name>
          <value>&MAIN_DIR;/RRFS_B/precip/<cyclestr offset="-86400">@Y@m@d-@H</cyclestr></value>
        </envar>
        <envar>
          <name>FHR</name>
          <value>#fhr#</value>
        </envar>
        <envar>
          <name>FIELD</name>
          <value>precip</value>
        </envar>
        <envar>
          <name>CONFIG_DIR</name>
          <value>&CONFIG_DIR;</value>
        </envar>
        <envar>
          <name>STATIC_DIR</name>
          <value>&STATIC_DIR;</value>
        </envar>
        <envar>
          <name>MODEL_NAME</name>
          <value>RRFS_B</value>
        </envar>
        <envar>
          <name>MET_BASE</name>
          <value>&MET_BASE;</value>
        </envar>

        <dependency>
          <datadep>&OBS_REALTIME_DIR;/precip/<cyclestr offset="-86400">st4_conus.@Y@m@d@H.06h.grib2</cyclestr></datadep>
        </dependency>

    </task>

  </metatask>

  <task name="gsl_mode_load_db" cycledefs="all" maxtries="2">
    <command>&SCRIPT_DIR;/wrapper.ksh</command>
    <jobname><cyclestr offset="-108000">gfs_mode_load_db_@Y@m@d@H</cyclestr></jobname>
    <join><cyclestr offset="-108000">&WF_LOG_DIR;/gfs_mode_db_@Y@m@d@H.log</cyclestr></join>

    &SERVICE_OPTS;
    &YMDH108000;

    <envar>
      <name>SCRIPT</name>
      <value>&SCRIPT_DIR;/mvcopier_with_ens.py</value>
    </envar>
    <envar>
      <name>MAIN_DIR</name>
      <value>&MAIN_DIR;</value>
    </envar>
    <envar>
      <name>PYTHON_PATH</name>
      <value>&PYTHON_PATH;</value>
    </envar>
    <envar>
      <name>MVLOAD_PATH</name>
      <value>&MVLOAD_PATH;</value>
    </envar>
    <envar>
      <name>CFG_DIR</name>
      <value>&CONFIG_DIR;</value>
    </envar>
    <envar>
      <name>CFG_XML</name>
      <value>mv_load_gsd.xml</value>
    </envar>
    <envar>
      <name>CFG_XML_ENS</name>
      <value>mv_load_gsd_ens.xml</value>
    </envar>
    <envar>
      <name>MODEL_LIST</name>
      <value>HRRR_OPS RRFS_NA_3km_dev1_HRRR RRFS_A RRFS_B</value>
    </envar>
    <envar>
      <name>MODEL_LIST_ENS</name>
      <value>RRFSE</value>
    </envar>
    <envar>
      <name>DATA_TYPES</name>
      <value>compref precip</value>
    </envar>

    <dependency>
      <timedep><cyclestr offset="&WAIT;">@Y@m@d@H@M@S</cyclestr></timedep>
    </dependency>

  </task> 

</workflow>
